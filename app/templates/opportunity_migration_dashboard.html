<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opportunity Migration Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .pipeline-card {
            border-left: 4px solid #0d6efd;
            transition: all 0.3s ease;
        }
        .pipeline-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .stage-badge {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .similarity-high { color: #28a745; }
        .similarity-medium { color: #ffc107; }
        .similarity-low { color: #dc3545; }
        .migration-status {
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .test-mode-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .progress-custom {
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
        }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 8px;
        }
        .log-entry {
            margin: 0.2rem 0;
        }
        .opportunity-preview {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-sitemap text-primary"></i>
                        Opportunity Migration Dashboard
                        <span class="badge bg-info ms-2">Phase 2</span>
                    </h1>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="loadConfig()">
                            <i class="fas fa-sync-alt"></i> Refresh Config
                        </button>
                        <button class="btn btn-primary" onclick="showPreview()">
                            <i class="fas fa-eye"></i> Preview Migration
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card migration-status" id="statusCard">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-info-circle"></i> Migration Status
                                </h5>
                                <p class="card-text mb-0" id="statusText">Ready to start opportunity migration</p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <div id="testModeIndicator"></div>
                                <div id="migrationTagIndicator"></div>
                            </div>
                        </div>
                        <div class="progress progress-custom mt-3" id="progressContainer" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" id="progressBar">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Pipeline Mapping Section -->
            <div class="col-md-8">
                <!-- Pipeline Mapping Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-route"></i> Pipeline & Stage Mapping
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="generatePipelineMapping()">
                            <i class="fas fa-magic"></i> Generate Smart Mapping
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pipelineMappingContent">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-magic fa-3x mb-3"></i>
                                <p>Click "Generate Smart Mapping" to analyze pipelines and create intelligent mappings</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Migration Preview Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search"></i> Migration Preview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="previewContent">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-eye fa-2x mb-3"></i>
                                <p>Generate pipeline mapping first, then preview what will be migrated</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="col-md-4">
                <!-- Migration Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle"></i> Migration Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="startMigration()" id="startMigrationBtn">
                                <i class="fas fa-rocket"></i> Start Migration
                            </button>
                            <button class="btn btn-info" onclick="showPreview()">
                                <i class="fas fa-eye"></i> Preview Migration
                            </button>
                            <button class="btn btn-warning" onclick="checkMigrationStatus()">
                                <i class="fas fa-chart-line"></i> Check Status
                            </button>
                            <button class="btn btn-secondary" onclick="viewPipelines('child')">
                                <i class="fas fa-list"></i> View Child Pipelines
                            </button>
                            <button class="btn btn-secondary" onclick="viewPipelines('master')">
                                <i class="fas fa-list"></i> View Master Pipelines
                            </button>
                        </div>
                        
                        <hr>
                        
                        <h6>Configuration</h6>
                        <div id="configInfo" class="small text-muted">
                            Loading configuration...
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-alt"></i> Activity Log
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container" id="activityLog">
                            <div class="log-entry">System ready. Load configuration to begin...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Details Modal -->
    <div class="modal fade" id="pipelineModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pipelineModalTitle">Pipeline Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="pipelineModalBody">
                    <!-- Pipeline details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Migration Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Migration Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="resultsModalBody">
                    <!-- Results will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let migrationActive = false;
        let currentConfig = {};
        let currentMapping = null;
        
        // Activity log functions
        function addLog(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `[${timestamp}] ${icon} ${message}`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('activityLog').innerHTML = 
                '<div class="log-entry">Log cleared. System ready...</div>';
        }
        
        // Configuration functions
        async function loadConfig() {
            try {
                addLog('Loading configuration...');
                const response = await fetch('/api/opportunity-migration/config');
                const data = await response.json();
                
                if (data.success) {
                    currentConfig = data.config;
                    updateConfigDisplay();
                    addLog('Configuration loaded successfully', 'success');
                } else {
                    addLog(`Failed to load configuration: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addLog(`Error loading configuration: ${error.message}`, 'error');
            }
        }
        
        function updateConfigDisplay() {
            const configDiv = document.getElementById('configInfo');
            const testIndicator = document.getElementById('testModeIndicator');
            const tagIndicator = document.getElementById('migrationTagIndicator');
            
            configDiv.innerHTML = `
                <div><strong>Child Location:</strong> ${currentConfig.child_location_id}</div>
                <div><strong>Master Location:</strong> ${currentConfig.master_location_id}</div>
                <div><strong>Batch Size:</strong> ${currentConfig.migration_batch_size}</div>
                <div><strong>Rate Limit:</strong> ${currentConfig.rate_limit_delay}s</div>
                <div><strong>API Keys:</strong> ${currentConfig.has_child_api_key && currentConfig.has_master_api_key ? '✅ Configured' : '❌ Missing'}</div>
            `;
            
            // Test mode indicator
            if (currentConfig.test_settings?.test_mode) {
                testIndicator.innerHTML = `
                    <span class="badge test-mode-badge me-2">
                        <i class="fas fa-flask"></i> TEST MODE: ${currentConfig.test_settings.test_limit} opportunities
                    </span>
                `;
            } else {
                testIndicator.innerHTML = `
                    <span class="badge bg-success me-2">
                        <i class="fas fa-rocket"></i> PRODUCTION MODE
                    </span>
                `;
            }
            
            // Migration tag indicator
            if (currentConfig.test_settings?.migration_tag) {
                tagIndicator.innerHTML = `
                    <span class="badge bg-info">
                        <i class="fas fa-tag"></i> Tag: ${currentConfig.test_settings.migration_tag}
                    </span>
                `;
            }
        }
        
        // Pipeline mapping functions
        async function generatePipelineMapping() {
            try {
                addLog('Generating smart pipeline mapping...');
                document.getElementById('pipelineMappingContent').innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Analyzing pipelines and generating smart mappings...</p>
                    </div>
                `;
                
                const response = await fetch('/api/opportunity-migration/pipeline-mapping');
                const data = await response.json();
                
                if (data.success) {
                    currentMapping = data;
                    displayPipelineMapping(data);
                    addLog(`Pipeline mapping generated: ${data.total_pipelines_mapped} pipelines, ${data.total_stages_mapped} stages`, 'success');
                } else {
                    addLog(`Failed to generate pipeline mapping: ${data.error}`, 'error');
                    document.getElementById('pipelineMappingContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                addLog(`Error generating pipeline mapping: ${error.message}`, 'error');
                document.getElementById('pipelineMappingContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${error.message}
                    </div>
                `;
            }
        }
        
        function displayPipelineMapping(data) {
            const container = document.getElementById('pipelineMappingContent');
            
            if (!data.pipeline_matches || data.pipeline_matches.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No pipeline mappings found. 
                        Make sure both locations have pipelines with similar names.
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="text-center">
                            <h6 class="text-primary"><i class="fas fa-download"></i> Child Pipelines</h6>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <h6 class="text-success"><i class="fas fa-upload"></i> Master Pipelines</h6>
                        </div>
                    </div>
                </div>
            `;
            
            data.pipeline_matches.forEach(match => {
                const similarityClass = match.similarity >= 0.8 ? 'similarity-high' : 
                                      match.similarity >= 0.6 ? 'similarity-medium' : 'similarity-low';
                
                html += `
                    <div class="card pipeline-card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-5">
                                    <div class="text-primary">
                                        <i class="fas fa-sitemap"></i> <strong>${match.child_name}</strong>
                                    </div>
                                    <small class="text-muted">ID: ${match.child_id}</small>
                                </div>
                                <div class="col-md-2 text-center">
                                    <i class="fas fa-arrow-right text-info"></i>
                                    <div class="badge bg-secondary ${similarityClass}">
                                        ${Math.round(match.similarity * 100)}%
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="text-success">
                                        <i class="fas fa-sitemap"></i> <strong>${match.master_name}</strong>
                                    </div>
                                    <small class="text-muted">ID: ${match.master_id}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Show stage mappings
            if (data.stage_matches && data.stage_matches.length > 0) {
                html += `
                    <hr>
                    <h6 class="mt-4 mb-3"><i class="fas fa-layer-group"></i> Stage Mappings</h6>
                `;
                
                const stagesByPipeline = {};
                data.stage_matches.forEach(stage => {
                    if (!stagesByPipeline[stage.pipeline]) {
                        stagesByPipeline[stage.pipeline] = [];
                    }
                    stagesByPipeline[stage.pipeline].push(stage);
                });
                
                Object.keys(stagesByPipeline).forEach(pipeline => {
                    html += `<div class="mb-3"><strong>${pipeline}:</strong><br>`;
                    stagesByPipeline[pipeline].forEach(stage => {
                        const similarityClass = stage.similarity >= 0.8 ? 'similarity-high' : 
                                              stage.similarity >= 0.6 ? 'similarity-medium' : 'similarity-low';
                        html += `
                            <span class="badge stage-badge me-2 mb-1">
                                ${stage.child_stage_name} → ${stage.master_stage_name} 
                                <span class="${similarityClass}">(${Math.round(stage.similarity * 100)}%)</span>
                            </span>
                        `;
                    });
                    html += `</div>`;
                });
            }
            
            container.innerHTML = html;
        }
        
        // Migration preview
        async function showPreview() {
            try {
                addLog('Loading migration preview...');
                const response = await fetch('/api/opportunity-migration/preview');
                const data = await response.json();
                
                if (data.success) {
                    displayPreview(data.preview);
                    addLog(`Preview loaded: ${data.preview.total_opportunities} opportunities to migrate`, 'success');
                } else {
                    addLog(`Failed to load preview: ${data.error}`, 'error');
                }
            } catch (error) {
                addLog(`Error loading preview: ${error.message}`, 'error');
            }
        }
        
        function displayPreview(preview) {
            const container = document.getElementById('previewContent');
            
            let html = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${preview.total_opportunities}</h5>
                                <p class="card-text">Total Opportunities</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${preview.contact_mapping_count}</h5>
                                <p class="card-text">Mapped Contacts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${preview.opportunities_by_pipeline.length}</h5>
                                <p class="card-text">Mapped Pipelines</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (preview.test_mode) {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-flask"></i> <strong>Test Mode Active:</strong> 
                        Only ${preview.test_limit} opportunities will be processed.
                    </div>
                `;
            }
            
            // Show opportunities by pipeline
            preview.opportunities_by_pipeline.forEach(pipeline => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-sitemap"></i> ${pipeline.child_pipeline_name}
                                <span class="badge bg-primary ms-2">${pipeline.opportunity_count} opportunities</span>
                            </h6>
                        </div>
                        <div class="card-body">
                `;
                
                if (pipeline.opportunities_preview && pipeline.opportunities_preview.length > 0) {
                    html += `<h6>Sample Opportunities:</h6>`;
                    pipeline.opportunities_preview.forEach(opp => {
                        html += `
                            <div class="opportunity-preview">
                                <strong>${opp.title || 'Untitled'}</strong>
                                <span class="badge bg-secondary ms-2">${opp.status || 'unknown'}</span>
                                ${opp.monetaryValue ? `<span class="text-success ms-2">$${opp.monetaryValue}</span>` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += `<p class="text-muted">No opportunities found in this pipeline.</p>`;
                }
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Migration control functions
        async function startMigration() {
            if (migrationActive) {
                addLog('Migration already in progress', 'warning');
                return;
            }
            
            if (!currentMapping) {
                addLog('Please generate pipeline mapping first', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to start the opportunity migration? This will create new opportunities in the master location.')) {
                return;
            }
            
            try {
                addLog('Starting opportunity migration...');
                migrationActive = true;
                updateMigrationUI(true);
                
                const response = await fetch('/api/opportunity-migration/migrate', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    addLog('Migration started successfully', 'success');
                    startStatusPolling();
                } else {
                    addLog(`Failed to start migration: ${data.error}`, 'error');
                    migrationActive = false;
                    updateMigrationUI(false);
                }
            } catch (error) {
                addLog(`Error starting migration: ${error.message}`, 'error');
                migrationActive = false;
                updateMigrationUI(false);
            }
        }
        
        function updateMigrationUI(active) {
            const startBtn = document.getElementById('startMigrationBtn');
            const progressContainer = document.getElementById('progressContainer');
            
            if (active) {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Migration Running...';
                progressContainer.style.display = 'block';
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Migration';
                progressContainer.style.display = 'none';
            }
        }
        
        async function checkMigrationStatus() {
            try {
                const response = await fetch('/api/opportunity-migration/status');
                const data = await response.json();
                
                if (data.success) {
                    updateMigrationStatus(data.status);
                }
            } catch (error) {
                addLog(`Error checking status: ${error.message}`, 'error');
            }
        }
        
        function updateMigrationStatus(status) {
            const statusText = document.getElementById('statusText');
            const progressBar = document.getElementById('progressBar');
            
            if (status.active) {
                migrationActive = true;
                statusText.textContent = `${status.stage}: ${status.message}`;
                
                if (status.total > 0) {
                    const percentage = Math.round((status.current / status.total) * 100);
                    progressBar.style.width = `${percentage}%`;
                    progressBar.textContent = `${status.current}/${status.total} (${percentage}%)`;
                }
                
                addLog(`${status.stage}: ${status.current}/${status.total} - ${status.message}`);
            } else {
                migrationActive = false;
                updateMigrationUI(false);
                
                if (status.results) {
                    statusText.textContent = `Migration completed: ${status.results.migrated} opportunities migrated`;
                    addLog(`Migration completed successfully: ${status.results.migrated} migrated, ${status.results.failed} failed`, 'success');
                    showMigrationResults(status.results);
                } else if (status.error) {
                    statusText.textContent = `Migration failed: ${status.error}`;
                    addLog(`Migration failed: ${status.error}`, 'error');
                }
            }
        }
        
        function startStatusPolling() {
            const pollInterval = setInterval(async () => {
                await checkMigrationStatus();
                
                if (!migrationActive) {
                    clearInterval(pollInterval);
                }
            }, 2000);
        }
        
        function showMigrationResults(results) {
            const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
            const body = document.getElementById('resultsModalBody');
            
            let html = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h4 class="text-success">${results.migrated}</h4>
                                <p class="card-text">Migrated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <h4 class="text-danger">${results.failed}</h4>
                                <p class="card-text">Failed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h4 class="text-warning">${results.skipped}</h4>
                                <p class="card-text">Skipped</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <h4 class="text-info">${results.total_processed}</h4>
                                <p class="card-text">Total Processed</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (results.migration_results && results.migration_results.length > 0) {
                html += `
                    <h5>Detailed Results:</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Child ID</th>
                                    <th>Master ID</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                results.migration_results.forEach(result => {
                    const statusBadge = result.status === 'success' ? 'bg-success' : 'bg-danger';
                    html += `
                        <tr>
                            <td>${result.title || 'Unknown'}</td>
                            <td><span class="badge ${statusBadge}">${result.status}</span></td>
                            <td><small>${result.child_opportunity_id}</small></td>
                            <td><small>${result.master_opportunity_id || '-'}</small></td>
                            <td><small class="text-danger">${result.error || '-'}</small></td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            }
            
            body.innerHTML = html;
            modal.show();
        }
        
        // Pipeline viewing functions
        async function viewPipelines(location) {
            try {
                addLog(`Loading ${location} pipelines...`);
                const response = await fetch(`/api/opportunity-migration/pipelines/${location}`);
                const data = await response.json();
                
                if (data.success) {
                    showPipelineModal(data.pipelines, location);
                    addLog(`Loaded ${data.count} ${location} pipelines`, 'success');
                } else {
                    addLog(`Failed to load ${location} pipelines`, 'error');
                }
            } catch (error) {
                addLog(`Error loading ${location} pipelines: ${error.message}`, 'error');
            }
        }
        
        function showPipelineModal(pipelines, location) {
            const modal = new bootstrap.Modal(document.getElementById('pipelineModal'));
            const title = document.getElementById('pipelineModalTitle');
            const body = document.getElementById('pipelineModalBody');
            
            title.textContent = `${location.charAt(0).toUpperCase() + location.slice(1)} Pipelines`;
            
            let html = '';
            pipelines.forEach(pipeline => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-sitemap"></i> ${pipeline.name}
                                <span class="badge bg-primary ms-2">${pipeline.stages ? pipeline.stages.length : 0} stages</span>
                            </h6>
                            <small class="text-muted">ID: ${pipeline.id}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;
                
                if (pipeline.stages && pipeline.stages.length > 0) {
                    pipeline.stages.forEach(stage => {
                        html += `
                            <div class="col-md-4 mb-2">
                                <span class="badge stage-badge">${stage.name}</span>
                                <br><small class="text-muted">${stage.id}</small>
                            </div>
                        `;
                    });
                } else {
                    html += `<div class="col-12"><p class="text-muted">No stages found</p></div>`;
                }
                
                html += `
                            </div>
                            <button class="btn btn-sm btn-outline-info mt-2" onclick="viewPipelineOpportunities('${pipeline.id}', '${location}')">
                                <i class="fas fa-list"></i> View Opportunities
                            </button>
                        </div>
                    </div>
                `;
            });
            
            body.innerHTML = html;
            modal.show();
        }
        
        async function viewPipelineOpportunities(pipelineId, location) {
            try {
                addLog(`Loading opportunities from ${location} pipeline...`);
                const response = await fetch(`/api/opportunity-migration/pipelines/${pipelineId}/opportunities?location=${location}`);
                const data = await response.json();
                
                if (data.success) {
                    addLog(`Found ${data.count} opportunities in pipeline`, 'success');
                    // Could add another modal or section to show opportunities
                } else {
                    addLog(`Failed to load opportunities from pipeline`, 'error');
                }
            } catch (error) {
                addLog(`Error loading pipeline opportunities: ${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            addLog('Opportunity Migration Dashboard initialized', 'success');
        });
    </script>
</body>
</html>
