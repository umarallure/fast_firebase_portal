{% extends "base.html" %}

{% block content %}
<script>
// Redirect to /login if not authenticated
firebase.auth().onAuthStateChanged(function(user) {
    if (!user) {
        window.location.href = "/login";
    }
});
</script>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-sitemap me-2"></i>
                        Export Pipelines & Stages Data
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This tool will export all pipelines and stages data from your configured GHL subaccounts to a CSV file.
                    </div>
                    
                    <!-- Export Button -->
                    <div class="text-center mb-4">
                        <button id="exportBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-download me-2"></i>
                            Export Pipelines & Stages Data
                        </button>
                    </div>
                    
                    <!-- Progress Section -->
                    <div id="progressSection" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Processing...
                                </h5>
                                <div class="progress mb-3">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%">
                                        <span id="progressText">Starting export...</span>
                                    </div>
                                </div>
                                <div id="statusText" class="text-muted">
                                    Initializing export process...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Export Complete
                                </h5>
                                <div id="resultsContent"></div>
                                <div id="downloadSection" class="mt-3" style="display: none;">
                                    <a id="downloadBtn" class="btn btn-success" href="#" download>
                                        <i class="fas fa-file-download me-2"></i>
                                        Download CSV File
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error Section -->
                    <div id="errorSection" style="display: none;">
                        <div class="alert alert-danger">
                            <h5>
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Export Failed
                            </h5>
                            <div id="errorContent"></div>
                        </div>
                    </div>
                    
                    <!-- Failed Accounts Section -->
                    <div id="failedAccountsSection" style="display: none;">
                        <div class="card mt-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Failed Accounts
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="failedAccountsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('exportBtn');
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');
    const errorSection = document.getElementById('errorSection');
    const failedAccountsSection = document.getElementById('failedAccountsSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusText = document.getElementById('statusText');
    
    exportBtn.addEventListener('click', async function() {
        // Reset UI
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';
        errorSection.style.display = 'none';
        failedAccountsSection.style.display = 'none';
        exportBtn.disabled = true;
        
        // Update progress
        progressBar.style.width = '25%';
        progressText.textContent = 'Connecting to GHL API...';
        statusText.textContent = 'Fetching pipeline data from subaccounts...';
        
        try {
            const response = await fetch('/api/export-pipelines-stages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            progressBar.style.width = '100%';
            progressText.textContent = 'Complete';
            
            if (data.success) {
                // Show success results
                progressSection.style.display = 'none';
                resultsSection.style.display = 'block';
                
                const resultsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">${data.total_records}</h3>
                                    <p class="mb-0">Total Records</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-success">${data.processed_accounts}</h3>
                                    <p class="mb-0">Accounts Processed</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p class="text-success">${data.message}</p>
                    </div>
                `;
                
                document.getElementById('resultsContent').innerHTML = resultsHtml;
                
                // Setup download button
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = data.download_url;
                downloadBtn.download = data.filename;
                document.getElementById('downloadSection').style.display = 'block';
                
                // Show failed accounts if any
                if (data.failed_accounts && data.failed_accounts.length > 0) {
                    showFailedAccounts(data.failed_accounts);
                }
                
            } else {
                // Show error
                progressSection.style.display = 'none';
                errorSection.style.display = 'block';
                document.getElementById('errorContent').innerHTML = `
                    <p>${data.error}</p>
                    ${data.failed_accounts ? '<p>Check failed accounts section below for details.</p>' : ''}
                `;
                
                if (data.failed_accounts && data.failed_accounts.length > 0) {
                    showFailedAccounts(data.failed_accounts);
                }
            }
            
        } catch (error) {
            progressSection.style.display = 'none';
            errorSection.style.display = 'block';
            document.getElementById('errorContent').innerHTML = `
                <p>Network error: ${error.message}</p>
                <p>Please check your connection and try again.</p>
            `;
        } finally {
            exportBtn.disabled = false;
        }
    });
    
    function showFailedAccounts(failedAccounts) {
        let failedHtml = '<div class="table-responsive"><table class="table table-sm">';
        failedHtml += '<thead><tr><th>Account Name</th><th>Account ID</th><th>Error</th></tr></thead><tbody>';
        
        failedAccounts.forEach(account => {
            failedHtml += `
                <tr>
                    <td>${account.account_name || 'N/A'}</td>
                    <td>${account.account_id || 'N/A'}</td>
                    <td><small class="text-danger">${account.error}</small></td>
                </tr>
            `;
        });
        
        failedHtml += '</tbody></table></div>';
        document.getElementById('failedAccountsList').innerHTML = failedHtml;
        failedAccountsSection.style.display = 'block';
    }
});
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/js/auth-protect.js"></script>
{% endblock %}