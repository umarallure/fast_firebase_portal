{% extends "base.html" %}
{% block content %}
<script>
// Auth protection (same as existing)
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('bulk-update-content').style.display = 'none';
    function checkAuth() {
        if (!window.firebase || !firebase.auth) {
            setTimeout(checkAuth, 100);
            return;
        }
        const firebaseConfig = {
            apiKey: "AIzaSyASVU8LlpqQ4Dpc-BSSfxyRbsCXJtgjKy4",
            authDomain: "automation-portal-7a891.firebaseapp.com",
            databaseURL: "https://automation-portal-7a891.firebaseio.com",
            projectId: "automation-portal-7a891",
            storageBucket: "automation-portal-7a891.appspot.com",
            messagingSenderId: "850682394607",
            appId: "1:850682394607:web:e42c2edd1ed536a64f281a"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        firebase.auth().onAuthStateChanged(function(user) {
            if (!user) {
                window.location.href = "/login";
            } else {
                document.getElementById('bulk-update-content').style.display = '';
            }
        });
    }
    checkAuth();
});
</script>

<div class="container mt-5" id="bulk-update-content" style="display: none;">
    <div class="row">
        <div class="col-md-8">
            <h2 class="mb-4">
                <i class="fas fa-exchange-alt text-primary me-2"></i>
                Bulk Update Opportunity Pipeline & Stage (V2 API)
            </h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Home
            </a>
        </div>
    </div>

    <div class="alert alert-info">
        <h6><i class="fas fa-info-circle me-2"></i>CSV Format Requirements (V2 API):</h6>
        <p class="mb-1">Your CSV must contain these columns:</p>
        <ul class="mb-0">
            <li><strong>Opportunity ID</strong> - Direct GHL Opportunity ID (required)</li>
            <li><strong>pipeline</strong> - Target pipeline name</li>
            <li><strong>stage</strong> - Target stage name</li>
            <li><strong>Notes</strong> - Notes to add to contact (Contact ID required)</li>
            <li><strong>Account Id</strong> - Subaccount ID for access token mapping</li>
        </ul>
        <div class="alert alert-warning mt-2">
            <strong>Note:</strong> This version uses direct Opportunity IDs and v2 API with access tokens per account.
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-vial me-2"></i>Test V2 API Connection</h6>
        </div>
        <div class="card-body">
            <p class="mb-3">Test your access token and see available pipelines before uploading your CSV.</p>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Quick Load from Account Configuration:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="quick-account-id" placeholder="Account ID (1, 2, 3, 4)">
                        <button class="btn btn-outline-secondary" id="load-account-btn">
                            <i class="fas fa-download me-1"></i>Load Config
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-5">
                    <input type="text" class="form-control mb-2" id="test-access-token" placeholder="Enter Access Token">
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control mb-2" id="test-location-id" placeholder="Location ID (e.g., ve9EPM428h8vShlRW1KT)">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary" id="test-connection-btn">
                        <i class="fas fa-plug me-1"></i>Test Connection
                    </button>
                </div>
            </div>
            <div id="test-results" class="mt-3"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="csv-upload-form" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="csvFile" class="form-label">
                        <i class="fas fa-file-csv me-2"></i>Upload CSV File
                    </label>
                    <input class="form-control" type="file" id="csvFile" name="csvFile" accept=".csv" required />
                    <div class="form-text">Supported format: CSV files with Opportunity ID column</div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-upload me-2"></i>Start V2 API Processing
                </button>
            </form>

            <div id="upload-status" class="mt-3"></div>
            
            <div class="progress mt-3" style="height: 25px; display:none;" id="progress-bar-container">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%">0%</div>
            </div>

            <div id="processing-summary" class="mt-4" style="display: none;">
                <h5><i class="fas fa-chart-bar me-2"></i>Processing Summary</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="total-rows">0</h3>
                                <p class="card-text">Total Rows</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="success-count">0</h3>
                                <p class="card-text">Successful Updates</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger" id="failed-count">0</h3>
                                <p class="card-text">Failed Updates</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results-details" class="mt-4"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('load-account-btn').addEventListener('click', async function() {
    const accountId = document.getElementById('quick-account-id').value.trim();
    const resultsDiv = document.getElementById('test-results');
    const btn = this;
    
    if (!accountId) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">Please enter an account ID.</div>';
        return;
    }
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`/api/account/${accountId}/config`);
        const result = await response.json();
        
        if (result.success) {
            const account = result.account;
            document.getElementById('test-location-id').value = account.location_id || '';
            
            let statusHtml = `<div class="alert alert-info">
                <strong>Account ${account.id} - ${account.name}</strong><br>
                Location ID: <code>${account.location_id || 'Not configured'}</code><br>
                Access Token: ${account.has_access_token ? '✅ Configured' : '❌ Missing'}<br>
                API Key: ${account.has_api_key ? '✅ Configured' : '❌ Missing'}
            </div>`;
            
            if (!account.has_access_token) {
                statusHtml += '<div class="alert alert-warning">Please add your V2 access token to the form above and save it in <a href="/subaccounts" target="_blank">Subaccount Management</a>.</div>';
            }
            
            resultsDiv.innerHTML = statusHtml;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Account ${accountId} not found. Please configure it in <a href="/subaccounts" target="_blank">Subaccount Management</a> first.</div>`;
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading account configuration.</div>';
        console.error('Load account error:', error);
    } finally {
        btn.innerHTML = '<i class="fas fa-download me-1"></i>Load Config';
        btn.disabled = false;
    }
});

document.getElementById('test-connection-btn').addEventListener('click', async function() {
    const accessToken = document.getElementById('test-access-token').value.trim();
    const locationId = document.getElementById('test-location-id').value.trim();
    const resultsDiv = document.getElementById('test-results');
    const btn = this;
    
    if (!accessToken || !locationId) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">Please enter both access token and location ID.</div>';
        return;
    }
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/test-v2-connection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                access_token: accessToken,
                location_id: locationId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            let html = '<div class="alert alert-success"><strong>Connection Successful!</strong></div>';
            html += `<p><strong>Pipelines Found:</strong> ${result.pipelines_found}</p>`;
            
            if (result.pipelines && result.pipelines.length > 0) {
                html += '<p><strong>Available Pipelines:</strong></p><ul>';
                result.pipelines.forEach(p => {
                    html += `<li><strong>${p.name}</strong> (ID: <code>${p.id}</code>)</li>`;
                });
                html += '</ul>';
            }
            
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger"><strong>Connection Failed:</strong> ${result.message}</div>`;
            
            if (result.connection_test) {
                resultsDiv.innerHTML += `<p><strong>Details:</strong> ${result.connection_test.message}</p>`;
            }
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger"><strong>Error:</strong> Failed to test connection.</div>';
        console.error('Test connection error:', error);
    } finally {
        btn.innerHTML = '<i class="fas fa-plug me-1"></i>Test Connection';
        btn.disabled = false;
    }
});

document.getElementById('csv-upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('csvFile');
    const statusDiv = document.getElementById('upload-status');
    const progressContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const summaryDiv = document.getElementById('processing-summary');
    const resultsDiv = document.getElementById('results-details');

    // Reset UI
    statusDiv.innerHTML = '';
    resultsDiv.innerHTML = '';
    summaryDiv.style.display = 'none';
    progressContainer.style.display = 'block';
    
    if (!fileInput.files.length) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Please select a CSV file.</div>';
        progressContainer.style.display = 'none';
        return;
    }

    // Show processing status
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Processing CSV file with V2 API...</div>';
    progressBar.style.width = '10%';
    progressBar.innerText = '10%';

    const formData = new FormData();
    formData.append('csvFile', fileInput.files[0]);

    fetch('/api/bulk-update-pipeline-stage', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';
        progressBar.innerText = '100%';
        
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>V2 API Processing completed successfully!</div>';
            
            // Show summary
            document.getElementById('total-rows').textContent = data.total_rows || 0;
            
            let totalSuccess = 0;
            let totalFailed = 0;
            
            // Calculate totals from results
            if (data.results_by_account) {
                Object.values(data.results_by_account).forEach(result => {
                    totalSuccess += result.success_count || 0;
                    totalFailed += result.failed_count || 0;
                });
            }
            
            document.getElementById('success-count').textContent = totalSuccess;
            document.getElementById('failed-count').textContent = totalFailed;
            summaryDiv.style.display = 'block';
            
            // Show detailed results
            if (data.results_by_account) {
                let resultsHtml = '<h5><i class="fas fa-list-alt me-2"></i>Detailed Results by Account</h5>';
                
                for (const [accountName, result] of Object.entries(data.results_by_account)) {
                    resultsHtml += `
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">${accountName} 
                                    <span class="badge ${result.status === 'completed' ? 'bg-success' : 'bg-danger'}">${result.status}</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Successful Updates:</strong> <span class="text-success">${result.success_count}</span></p>
                                        <p><strong>Failed Updates:</strong> <span class="text-danger">${result.failed_count}</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        ${result.errors && result.errors.length > 0 ? 
                                            `<p><strong>Sample Errors:</strong></p><ul class="text-danger small">${result.errors.slice(0, 3).map(err => `<li>${err}</li>`).join('')}</ul>` : 
                                            '<p class="text-success">No errors reported</p>'
                                        }
                                    </div>
                                </div>
                                
                                ${result.update_results && result.update_results.length > 0 ? `
                                    <details class="mt-2">
                                        <summary>View Update Details (${result.update_results.length})</summary>
                                        <div class="table-responsive mt-2">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Opportunity ID</th>
                                                        <th>Pipeline</th>
                                                        <th>Stage</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${result.update_results.map(update => `
                                                        <tr>
                                                            <td><code>${update.opportunity_id}</code></td>
                                                            <td>${update.pipeline}</td>
                                                            <td>${update.stage}</td>
                                                            <td><span class="badge bg-success">Success</span></td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = resultsHtml;
            }
            
            // Add failed CSV download if available
            if (data.failed_csv_url) {
                statusDiv.innerHTML += '<br><a href="' + data.failed_csv_url + '" class="btn btn-warning" download><i class="fas fa-download me-2"></i>Download Failed Entries CSV</a>';
            }
            
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>' + (data.message || 'An error occurred during processing.') + '</div>';
            
            if (data.failed_csv_url) {
                statusDiv.innerHTML += '<br><a href="' + data.failed_csv_url + '" class="btn btn-warning" download><i class="fas fa-download me-2"></i>Download Failed Entries CSV</a>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        progressBar.style.width = '100%';
        progressBar.innerText = 'Error';
        progressBar.classList.add('bg-danger');
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>An error occurred while uploading the file.</div>';
    });
});
</script>
{% endblock %}
