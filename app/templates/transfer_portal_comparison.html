{% extends "base.html" %}
{% block content %}
<script>
// Redirect to /login if not authenticated
firebase.auth().onAuthStateChanged(function(user) {
    if (!user) {
        window.location.href = "/login";
    }
});
</script>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-exchange-alt text-info me-2"></i>Transfer Portal Comparison</h3>
                    <p class="mb-0 text-muted">Compare child and master CSV files to find new entries not present in master database</p>
                </div>
                <div class="card-body">
                    <!-- Info Section -->
                    <div class="alert alert-info" role="alert">
                        <h6><i class="fas fa-info-circle me-2"></i>How it works:</h6>
                        <ul class="mb-0">
                            <li>Upload your <strong>Master CSV</strong> (existing database) and <strong>Child CSV</strong> (new leads to check)</li>
                            <li>The system compares <strong>both phone numbers AND customer names</strong> between files for accurate matching</li>
                            <li>Returns entries from child file that are <strong>NOT</strong> found in master file</li>
                            <li>Automatically maps Account IDs to Account Names using environment settings</li>
                            <li>Generates a new CSV with master database structure</li>
                        </ul>
                    </div>

                    <!-- Upload Form -->
                    <form id="transferPortalForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="masterFile" class="form-label">
                                        <i class="fas fa-database text-primary me-2"></i>Master CSV File
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control" id="masterFile" name="master_file" 
                                           accept=".csv" required>
                                    <div class="form-text">
                                        Expected columns: Customer Phone Number, Name, Policy Status, GHL Pipeline Stage, CALL CENTER
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="childFile" class="form-label">
                                        <i class="fas fa-file-csv text-success me-2"></i>Child CSV File
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control" id="childFile" name="child_file" 
                                           accept=".csv" required>
                                    <div class="form-text">
                                        Expected columns: Contact Name, phone, pipeline, stage, Account Id
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="returnFormat" class="form-label">
                                        <i class="fas fa-file-export text-warning me-2"></i>Output Format
                                    </label>
                                    <select class="form-select" id="returnFormat" name="return_format">
                                        <option value="csv">CSV File Download</option>
                                        <option value="json">JSON Response (with statistics)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 mb-3">
                            <button type="button" class="btn btn-outline-info" id="previewBtn">
                                <i class="fas fa-eye me-2"></i>Preview Files
                            </button>
                            <button type="submit" class="btn btn-primary" id="processBtn">
                                <i class="fas fa-play me-2"></i>Process Comparison
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </button>
                        </div>
                    </form>

                    <!-- Progress Section -->
                    <div id="progressSection" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-spinner fa-spin me-2"></i>Processing...</h6>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 100%"></div>
                                </div>
                                <small class="text-muted">Comparing files and generating results...</small>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Processing Complete</h6>
                            </div>
                            <div class="card-body">
                                <div id="resultsContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div id="previewSection" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-eye me-2"></i>File Preview</h6>
                            </div>
                            <div class="card-body">
                                <div id="previewContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Section -->
                    <div id="errorSection" style="display: none;">
                        <div class="alert alert-danger" role="alert">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error</h6>
                            <div id="errorMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('transferPortalForm');
    const processBtn = document.getElementById('processBtn');
    const previewBtn = document.getElementById('previewBtn');
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');
    const previewSection = document.getElementById('previewSection');
    const errorSection = document.getElementById('errorSection');

    // Preview Files
    previewBtn.addEventListener('click', async function() {
        const masterFile = document.getElementById('masterFile').files[0];
        const childFile = document.getElementById('childFile').files[0];

        if (!masterFile && !childFile) {
            showError('Please select at least one file to preview.');
            return;
        }

        const formData = new FormData();
        if (masterFile) formData.append('master_file', masterFile);
        if (childFile) formData.append('child_file', childFile);

        try {
            const response = await fetch('/api/transfer-portal-comparison/preview', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                showPreview(data);
            } else {
                const error = await response.json();
                showError(error.detail || 'Failed to preview files');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        }
    });

    // Process Form
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const masterFile = document.getElementById('masterFile').files[0];
        const childFile = document.getElementById('childFile').files[0];
        const returnFormat = document.getElementById('returnFormat').value;

        if (!masterFile || !childFile) {
            showError('Please select both master and child CSV files.');
            return;
        }

        hideAllSections();
        progressSection.style.display = 'block';
        processBtn.disabled = true;

        const formData = new FormData();
        formData.append('master_file', masterFile);
        formData.append('child_file', childFile);
        formData.append('return_format', returnFormat);

        try {
            const response = await fetch('/api/transfer-portal-comparison/process', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                if (returnFormat === 'csv') {
                    // Handle CSV download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `transfer_portal_new_entries_${new Date().getTime()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showResults({
                        message: 'CSV file downloaded successfully!',
                        format: 'csv'
                    });
                } else {
                    // Handle JSON response
                    const data = await response.json();
                    showResults(data);
                }
            } else {
                const error = await response.json();
                showError(error.detail || 'Processing failed');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            progressSection.style.display = 'none';
            processBtn.disabled = false;
        }
    });

    function hideAllSections() {
        progressSection.style.display = 'none';
        resultsSection.style.display = 'none';
        previewSection.style.display = 'none';
        errorSection.style.display = 'none';
    }

    function showError(message) {
        hideAllSections();
        document.getElementById('errorMessage').textContent = message;
        errorSection.style.display = 'block';
    }

    function showPreview(data) {
        hideAllSections();
        let html = '';

        if (data.master_preview) {
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-database text-primary me-2"></i>Master File: ${data.master_preview.filename}</h6>
                    <p>Rows: ${data.master_preview.row_count} | Columns: ${data.master_preview.columns.join(', ')}</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr>${data.master_preview.columns.map(col => `<th>${col}</th>`).join('')}</tr></thead>
                            <tbody>
                                ${data.master_preview.sample_data.map(row => 
                                    `<tr>${data.master_preview.columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        if (data.child_preview) {
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-file-csv text-success me-2"></i>Child File: ${data.child_preview.filename}</h6>
                    <p>Rows: ${data.child_preview.row_count} | Columns: ${data.child_preview.columns.join(', ')}</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr>${data.child_preview.columns.map(col => `<th>${col}</th>`).join('')}</tr></thead>
                            <tbody>
                                ${data.child_preview.sample_data.map(row => 
                                    `<tr>${data.child_preview.columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        document.getElementById('previewContent').innerHTML = html;
        previewSection.style.display = 'block';
    }

    function showResults(data) {
        hideAllSections();
        let html = '';

        if (data.format === 'csv') {
            html = `
                <div class="alert alert-success">
                    <i class="fas fa-download me-2"></i>${data.message}
                </div>
            `;
        } else {
            html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Processing Statistics</h6>
                        <ul>
                            <li>Total Child Entries: ${data.stats.total_child_entries}</li>
                            <li>Found in Master: ${data.stats.entries_found_in_master}</li>
                            <li>New Entries: ${data.stats.new_entries_count}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Summary Report</h6>
                        <pre class="bg-light p-2 rounded" style="font-size: 0.9em;">${data.summary}</pre>
                    </div>
                </div>
                ${data.new_entries.length > 0 ? `
                    <div class="mt-3">
                        <h6>Sample New Entries (First 5)</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Phone</th>
                                        <th>Name</th>
                                        <th>Pipeline Stage</th>
                                        <th>Call Center</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.new_entries.slice(0, 5).map(entry => `
                                        <tr>
                                            <td>${entry['Customer Phone Number'] || ''}</td>
                                            <td>${entry['Name'] || ''}</td>
                                            <td>${entry['GHL Pipeline Stage'] || ''}</td>
                                            <td>${entry['CALL CENTER'] || ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : '<div class="alert alert-info mt-3">No new entries found - all child entries exist in master file.</div>'}
            `;
        }

        document.getElementById('resultsContent').innerHTML = html;
        resultsSection.style.display = 'block';
    }
});
</script>

<style>
.card {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.progress {
    height: 8px;
}

.table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.form-text {
    font-size: 0.875rem;
}

.alert ul {
    margin-bottom: 0;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/js/auth-protect.js"></script>
{% endblock %}
