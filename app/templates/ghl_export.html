{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">GHL Pipeline & Notes Export</h2>
    <div class="card mb-4">
        <div class="card-body">
            <form id="ghl-export-form">
                <div class="mb-3">
                    <label class="form-label">Select Sub-Accounts (Centers)</label>
                    <div id="subaccount-checkboxes" class="form-check">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>
                <button type="button" class="btn btn-primary" id="generate-report-btn">Generate Report</button>
            </form>
            <div id="export-status" class="mt-3"></div>
            <div id="csv-download-link" class="mt-3"></div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch subaccounts and populate checkboxes
    fetch('/api/subaccounts')
        .then(res => res.json())
        .then(subaccounts => {
            const container = document.getElementById('subaccount-checkboxes');
            subaccounts.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'form-check';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'form-check-input';
                input.id = 'sub_' + sub.id;
                input.value = sub.id;
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = input.id;
                label.textContent = sub.name;
                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        });

    // Handle Generate Report button click
    document.getElementById('generate-report-btn').addEventListener('click', function() {
        const selected = Array.from(document.querySelectorAll('#subaccount-checkboxes input:checked')).map(cb => cb.value);
        const statusDiv = document.getElementById('export-status');
        const linkDiv = document.getElementById('csv-download-link');
        statusDiv.textContent = '';
        linkDiv.textContent = '';
        if (selected.length === 0) {
            statusDiv.textContent = 'Please select at least one sub-account.';
            return;
        }
        statusDiv.textContent = 'Generating report, please wait...';
        // Build query string for selected subaccounts
        const params = selected.map(id => 'subaccount_ids=' + encodeURIComponent(id)).join('&');
        fetch('/export-ghl-opportunities?' + params)
            .then(response => {
                if (!response.ok) throw new Error('Export failed');
                return response.blob();
            })
            .then(blob => {
                statusDiv.textContent = 'Report ready!';
                const url = window.URL.createObjectURL(blob);
                linkDiv.innerHTML = `<a href="${url}" download="ghl_opportunities_export.csv" class="btn btn-success">Download CSV</a>`;
            })
            .catch(err => {
                statusDiv.textContent = 'Error: ' + err.message;
            });
    });
});
</script>
{% endblock %}
